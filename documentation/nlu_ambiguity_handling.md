# NLU Ambiguity Handling Plan

This document outlines the planned changes to the Natural Language Understanding (NLU) and action processing pipeline to handle ambiguous player inputs. The primary components affected are `PlayerActionParser` and `TurnProcessor`.

## 1. `PlayerActionParser` (`bot/nlu/player_action_parser.py`) Changes

The `PlayerActionParser` will be updated to identify and return multiple potential interpretations of player input, rather than trying to force a single best guess in all cases.

*   **Output Structure Modification:**
    *   The current `action_data['intent']` (string) will be replaced or augmented by `action_data['possible_intents']`.
    *   `possible_intents` will be a `List[Dict[str, Any]]`. Each dictionary in the list will represent a potential intent and will have the following structure:
        ```json
        {
          "intent": "intent_verb_primary_target_secondary_target", // e.g., "action_attack_goblin_sword"
          "confidence": 0.85, // Float, score from 0.0 to 1.0
          "display_text_i18n": { // User-friendly description of this interpretation
            "en": "Attack the goblin with your sword."
          },
          "parsed_entities": { // Entities specifically identified for this intent
            "primary_target": {"id": "goblin_1", "name": "goblin", "type": "NPC"},
            "secondary_target": {"id": "item_sword_123", "name": "sword", "type": "Item"}
            // ... other relevant entities like source, instrument, location
          },
          "target_ambiguity": { // Optional: Present if multiple viable primary targets were found
            "field_name": "primary_target", // e.g., "primary_target", "secondary_target"
            "ambiguous_targets": [
              {"id": "goblin_1", "name": "goblin warrior", "display_text_i18n": {"en": "the goblin warrior"}},
              {"id": "goblin_2", "name": "goblin shaman", "display_text_i18n": {"en": "the goblin shaman"}}
            ]
          },
          "clarification_questions_needed": [ // Optional: Questions to ask if this intent is chosen but needs more info
            // e.g., {"field": "secondary_target", "question_key_i18n": "which_weapon_to_use"}
          ]
        }
        ```

*   **Confidence Score Assignment:**
    *   **MVP:** Confidence scores can be heuristics-based:
        *   Direct match of an action verb (e.g., "attack", "talk") from a predefined synonym list: High confidence (e.g., 0.9).
        *   Presence of keywords associated with an intent: Medium confidence (e.g., 0.6-0.8).
        *   Number of resolved entities matching an intent's expected pattern.
    *   **Future:** Could be replaced or augmented by scores from a machine learning model trained for intent classification.
    *   The sum of confidences for `possible_intents` does not need to be 1.0.

*   **`parsed_entities` Population:**
    *   For each potential intent, the parser will try to fill its expected entity slots (e.g., primary target, secondary target/instrument, location) from the entities extracted from the raw text.

*   **`target_ambiguity` Population:**
    *   If entity resolution identifies multiple equally viable candidates for a crucial entity slot (primarily the main target of an action), this field will be populated.
    *   Example: Player types "attack goblin" and there are three goblins (goblin_1, goblin_2, goblin_3) in the vicinity. The `target_ambiguity` field for the "action_attack" intent would list these three goblins.

## 2. `TurnProcessor` (`bot/game/turn_processor.py`) Changes

The `TurnProcessor` will be responsible for handling the `possible_intents` list generated by `PlayerActionParser`.

*   **Processing Logic:**
    *   When `PlayerActionParser` returns `action_data` containing `possible_intents`:
        1.  **Sort by Confidence:** Sort `possible_intents` in descending order of confidence.
        2.  **High Confidence Single Intent:** If the top intent has a significantly higher confidence (e.g., > 0.9 and at least 0.3 points higher than the next) and no `target_ambiguity`, proceed with this intent as if it were a single, unambiguous result.
        3.  **Only One Intent:** If there's only one intent in `possible_intents` (even with moderate confidence, e.g., > 0.5) and no `target_ambiguity`, proceed with it.
        4.  **Ambiguity Detected (Multiple Intents):** If multiple intents have comparable confidence scores (e.g., two intents with 0.7 and 0.65) or the top intent's confidence is low but not zero:
            *   **Initiate Clarification Flow (MVP):**
                *   Set `Character.current_game_status` to `"awaiting_clarification"`. (This might be a specific field on the Character model or a status effect).
                *   Store the relevant data for clarification in `Character.state_variables_json.pending_clarification_data`. This should include the original player text and a list of options for the player to choose from.
                    ```json
                    // Example for Character.state_variables_json.pending_clar_data
                    {
                      "original_text": "deal with the goblin",
                      "clarification_type": "intent_choice", // "intent_choice" or "target_choice"
                      "options": [
                        {"id": "option_1", "intent_data": { ... intent_1_details ... }, "display_text_i18n": {"en": "1. Attack the goblin?"}},
                        {"id": "option_2", "intent_data": { ... intent_2_details ... }, "display_text_i18n": {"en": "2. Talk to the goblin?"}}
                      ]
                    }
                    ```
                *   Use a `NotificationService` (or similar) to send a message to the player listing the ambiguous options with numbers (e.g., "Did you mean to:\n1. Attack the goblin?\n2. Talk to the goblin?\n3. Examine the goblin?\nPlease respond with the number of your choice (e.g., /clarify 1).").
        5.  **Target Ambiguity Detected (Single Intent with `target_ambiguity`):** If a single intent is chosen (either directly or after intent clarification) but it has `target_ambiguity`:
            *   **Initiate Clarification Flow (MVP):**
                *   Similar to intent ambiguity, set `Character.current_game_status` to `"awaiting_clarification"`.
                *   Store data in `Character.state_variables_json.pending_clarification_data`:
                    ```json
                    {
                      "original_text": "attack goblin",
                      "clarification_type": "target_choice",
                      "chosen_intent_data": { ... intent_details ... },
                      "ambiguous_field": "primary_target",
                      "options": [
                        {"id": "target_1", "target_data": {"id": "goblin_1", "name": "goblin warrior"}, "display_text_i18n": {"en": "1. The goblin warrior"}},
                        {"id": "target_2", "target_data": {"id": "goblin_2", "name": "goblin shaman"}, "display_text_i18n": {"en": "2. The goblin shaman"}}
                      ]
                    }
                    ```
                *   Send a message to the player: "Which target did you mean for 'attack goblin'?\n1. The goblin warrior\n2. The goblin shaman\nPlease respond with the number of your choice."
        6.  **Contextual Disambiguation (Future Enhancement):**
            *   Briefly note that future versions could attempt to automatically resolve some ambiguities.
            *   Before prompting the player, the `TurnProcessor` could analyze the game state:
                *   If in combat, an "attack" intent might be prioritized over "talk."
                *   If an NPC is already in dialogue with the player, "talk" might be prioritized.
                *   Proximity of targets could influence choice.
            *   This would involve more complex rule sets or a scoring system within the `TurnProcessor`.

## 3. `Character` Model Usage

*   The existing `Character.state_variables_json` field (JSONB) is suitable for storing `pending_clarification_data`. No immediate schema change to the `Character` model itself is required for this specific data, but its usage pattern will be new.
*   A field like `Character.current_game_status: Optional[str]` might be useful to explicitly track if the character is `"awaiting_clarification"`, which can gate other actions or command processing. This could be a new column or part of `state_variables_json`.

## 4. New Commands / Input Handling for Clarification

*   A mechanism for players to respond to clarification prompts is essential.
*   **Implementation:**
    *   A new command, e.g., `/clarify <option_number>` or `/c <option_number>`.
    *   Alternatively, if `Character.current_game_status` is `"awaiting_clarification"`, the system could interpret raw number inputs (e.g., "1", "2") as clarification choices.
*   **Processing Clarification:**
    *   The command handler for clarification would:
        1.  Retrieve `pending_clarification_data` from `Character.state_variables_json`.
        2.  Validate the player's choice against the available options.
        3.  If valid:
            *   If `clarification_type` was `intent_choice`: Re-submit the chosen `intent_data` (now unambiguous or with target ambiguity to resolve next) to the `TurnProcessor` or directly to the action execution phase.
            *   If `clarification_type` was `target_choice`: Update the `chosen_intent_data` with the selected target and then re-submit it.
        4.  Clear `pending_clarification_data` and reset `Character.current_game_status`.

## 5. Affected Tasks in Main Project List (Conceptual)

*   **Task 13 (NLU & Intent/Entity - `PlayerActionParser`):**
    *   Description to be significantly updated: "Modify `PlayerActionParser` to return a list of `possible_intents` (each with intent string, confidence score, display text, parsed entities, and optional `target_ambiguity` list). Implement heuristics or model integration for confidence scoring."
*   **Task 15 (Turn Processor - `TurnProcessor` / `CharacterActionProcessor`):**
    *   Description to be significantly updated: "Modify `TurnProcessor` to handle `possible_intents` from parser. Implement logic to:
        *   Proceed with high-confidence single intents.
        *   Initiate a player clarification flow (setting character status, storing clarification data, sending options to player) when multiple intents are comparably likely or a chosen intent has target ambiguity.
        *   (Future: Explore contextual disambiguation based on game state)."
*   **New Task: "Implement Player Input Handling for NLU Clarification Prompts"**:
    *   "Design and implement a command (e.g., `/clarify <option_number>`) or input mode for players to respond to NLU clarification questions. This handler will retrieve pending clarification data, apply the player's choice, and resubmit the disambiguated action for processing."
*   **Task 0.2/7 (Character Model - `Character`):**
    *   Add a note: "The `Character.state_variables_json` field will be used to store `pending_clarification_data` when NLU results are ambiguous. Consider adding `current_game_status: Optional[str]` to Character model for states like 'awaiting_clarification'."

This plan provides a structured approach to making NLU more robust by gracefully handling ambiguous inputs.
